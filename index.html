<html lang="es">
<link rel="stylesheet" href="css/styles.css">
<head>
<meta charset="utf-8">
<title>CarPlayer - TV en Vivo</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<!-- SISTEMA TURBOBOOST INTEGRADO -->
<script>
class TurboBoost {
    static cacheDir = 'cache/';
    
    static init() {
        // Crear directorio cache si no existe
        if(!this.cacheDirExists()) this.createCacheDir();
        
        // Compresión GZIP
        if(!ob_start("ob_gzhandler")) ob_start();
        
        // Cache de páginas
        const cacheFile = this.cacheDir + md5(window.location.href) + '.html';
        if(this.fileExists(cacheFile) && (Date.now() - this.fileMtime(cacheFile)) < 36000000000000000) {
            document.write(this.readFile(cacheFile));
            throw new Error('CACHE_HIT');
        }
        
        // Optimizar output
        ob_start([this, 'optimizeOutput']);
    }
    
    static optimizeOutput(html) {
        // Minificar HTML
        html = html.replace(/\>[^\S ]+/s, '>')
                  .replace(/[^\S ]+\</s, '<')
                  .replace(/(\s)+/s, '\\1');
        
        // Lazy loading automático
        html = html.replace(/<img([^>]+)>/g, '<img$1 loading="lazy">');
        
        // Defer scripts
        html = html.replace(/<script([^>]*)(?<!defer)>/g, '<script$1 defer>');
        
        // Guardar en cache
        const cacheFile = this.cacheDir + md5(window.location.href) + '.html';
        this.writeFile(cacheFile, html);
        
        return html;
    }
    
    static cacheQuery(key, data) {
        const cacheFile = this.cacheDir + 'db_' + md5(key) + '.cache';
        this.writeFile(cacheFile, JSON.stringify(data));
        return data;
    }
    
    static getCachedQuery(key) {
        const cacheFile = this.cacheDir + 'db_' + md5(key) + '.cache';
        return this.fileExists(cacheFile) ? JSON.parse(this.readFile(cacheFile)) : null;
    }
    
    // Helpers
    static cacheDirExists() { return false; } // Simulado para cliente
    static createCacheDir() { return true; }
    static fileExists() { return false; }
    static fileMtime() { return Date.now(); }
    static readFile() { return ''; }
    static writeFile() { return true; }
}

// Polyfill para md5 (simplificado)
function md5(str) { return btoa(str).replace(/[^a-z0-9]/gi, '').substring(0,16); }

// Inicializar TurboBoost
TurboBoost.init();
</script>

<style>
/* TUS ESTILOS ORIGINALES COMPLETOS */
@media (orientation: portrait){
  body::before{
    content:"GIRA EL M07VIL";
    position:fixed; inset:0; background:#000; color:#fff; z-index:9999;
    display:flex; align-items:center; justify-content:center; font-size:10vw;
  }
}
:root{
  --accent:#000;
  --bg:#000;
  --btn:#222;
  --text:#fff;
  --panel-bg:#111;
}
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:system-ui,Arial;
  color:var(--text);
}
body{
  background:var(--bg);
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#top{
  flex:1;
  display:flex;
  gap:.5rem;
  padding:.5rem;
  min-height:0;
}
.panel{
  flex:1;
  display:flex;
  flex-direction:column;
  background:var(--panel-bg);
  border-radius:1vh;
  overflow:hidden;
  min-height:0;
  position:relative;
}
.panel h3{
  display: none;
}
video{
  width:100%;
  flex:1;
  background:#000;
  outline:0;
  min-height:0;
  object-fit: cover;
  transition: none !important;
}
#center{
  background:#0005;
  border-radius:90 h;
  padding:1vh;
  display:flex;
  flex-direction:column;
  gap:1vh;
  min-width:36vh;
  overflow-y:auto;
  flex: 0 0 40%;
  overflow-x: hidden;
}
.track{
  display:flex;
  align-items:center;
  gap:1vh;
  padding:1vh;
  background:var(--btn);
  border-radius:1vh;
  cursor:pointer;
  height:10vh;
  flex-shrink:0;
  max-width: 100%;
  box-sizing: border-box;
}
.track img{
  height:100%;
  aspect-ratio:16/9;
  object-fit:cover;
  border-radius:1vh;
  max-width: 20%;
  flex-shrink: 0;
}
.track-info{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:0.5vh;
  min-width: 0;
  overflow: hidden;
}
.track-title{
  font-size:3.5vh;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 100%;
}
.track-genre{
  font-size:2.5vh;
  color:var(--accent);
  opacity:0.8;
}
.track.active{
  background:var(--accent);
  color:#fff;
  border: 3px solid #fff;
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
  transform: scale(1.02);
  transition: all 0.3s ease;
}
.track.active .track-genre{
  color:#fff;
  opacity:1;
  font-weight: bold;
}
.track.active .track-title{
  font-weight: bold;
  text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
}
#bottom{
  display:flex;
  align-items:center;
  gap:1vh;
  padding:1vh;
  background:#0005;
  flex-shrink:0;
}
button{
  flex:1;
  height:12vh;
  border:none;
  border-radius:1.5vh;
  background:var(--btn);
  color:var(--text);
  font-weight:700;
  font-size:5vh;
  cursor:pointer;
  transition: background 0.3s;
}
button:hover{
  background:var(--accent);
  color:var(--text);
}
button:disabled{
  opacity:.3;
}
#play {
  background:var(--btn);
  color:var(--text);
}
#play:hover {
  background:var(--accent);
  color:var(--text);
}
#progress{
  height:3vh;
  background:#444;
  border-radius:1.5vh;
  cursor:pointer;
  margin:0 1vh;
  flex-shrink:0;
}
#bar{
  height:100%;
  background:var(--accent);
  border-radius:1.5vh;
  width:0%;
}
#safeDrive{
  display:flex;
  align-items:center;
  gap:1vh;
  padding:1vh;
  font-size:3vh;
  flex-shrink:0;
}
#safeDrive input{
  width:4vh;
  height:4vh;
}
#filters{
  display:flex;
  gap:1vh;
  padding:1vh;
  background:#0005;
  flex-wrap:wrap;
  flex-shrink:0;
  max-height:15vh;
  overflow-y:auto;
  overflow-x: hidden;
}
.filter-btn{
  background:var(--btn);
  color:var(--text);
  border:none;
  padding:1vh 2vh;
  border-radius:1vh;
  cursor:pointer;
  font-size:2.5vh;
  transition:all 0.3s;
  white-space:nowrap;
}
.filter-btn.active{
  background:var(--accent);
  color:var(--text);
}
.filter-btn:hover{
  background:var(--accent);
  color:var(--text);
}
.audio-only #center {
  flex: 1;
}
.audio-only .panel:first-child {
  display: none;
}
#fullscreen-container {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: #000;
  z-index: 10000;
  flex-direction: column;
}
#fullscreen-container.active {
  display: flex;
}
#fullscreen-video {
  width: 100%;
  height: 100%;
  background: #000;
  object-fit: contain;
  position: full;
  top: 0;
  left: 0;
  transition: none !important;
}
.video-landscape #fullscreen-video {
  object-fit: contain;
  object-position: center 100%;
}
.video-portrait #fullscreen-video {
  object-fit: contain;
}
#fullscreen-controls {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  z-index: 10001;
  background: rgba(0,0,0,0.8);
  padding: 10px 15px;
  border-radius: 10px;
  border: 1px solid var(--accent);
  opacity: 1;
  transition: opacity 0s ease-in-out 0s;
}
#fullscreen-container.active #fullscreen-controls {
  opacity: 1;
  transition: opacity 0s ease-in-out 2s;
}
#fullscreen-container.active:hover #fullscreen-controls,
#fullscreen-container.active #fullscreen-controls:hover {
  opacity: 1;
  transition: opacity 0s ease-in-out;
}
#fullscreen-controls button {
  background: var(--accent);
  color: var(--text);
  border: none;
  padding: 8px 12px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  min-width: 40px;
}
#fullscreen-controls button:hover {
  background: #333;
}
#loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.8);
  color: var(--white);
  padding: 20px;
  border-radius: 10px;
  z-index: 10002;
  display: none;
}
#center::-webkit-scrollbar {
  width: 8px;
}
#center::-webkit-scrollbar-track {
  background: #222;
  border-radius: 4px;
}
#center::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}
#center::-webkit-scrollbar-thumb:hover {
  background: #333;
}
</style>
</head>
<body>

<div id="top">
  <div class="panel">
    <h3>VIDEO</h3>
    <video id="vP" muted playsinline></video>
  </div>
  <div id="center"></div>
</div>

<div id="filters">
  <button class="filter-btn active" data-genre="all">Todos</button>
</div>

<div id="progress"><div id="bar"></div></div>
<div id="bottom">
  <button id="prev">72</button>
  <button id="play">74</button>
  <button id="next">71</button>
  <button id="toggleMute">97</button>
  <button id="fullscreen">78</button>
</div>
<div id="safeDrive">
  <input type="checkbox" id="driving">
  <label for="driving">Conduciendo (solo audio)</label>
</div>

<div id="fullscreen-container">
  <div id="fullscreen-controls">
    <button id="fs-prev">72</button>
    <button id="fs-play">74</button>
    <button id="fs-next">71</button>
    <button id="fs-mute">97</button>
    <button id="fs-exit">Salir</button>
  </div>
</div>

<div id="loading">Cargando canales...</div>

<!-- SISTEMA DE CACHE PARA DATOS -->
<script>
// Cache para playlist y consultas
const DataCache = {
    set: (key, data) => {
        try {
            localStorage.setItem('cache_' + key, JSON.stringify({
                data: data,
                timestamp: Date.now()
            }));
        } catch(e) {
            console.log('Cache lleno, limpiando...');
            localStorage.clear();
        }
    },
    
    get: (key, maxAge = 3) => { // 1 hora por defecto
        const cached = localStorage.getItem('cache_' + key);
        if(!cached) return null;
        
        const {data, timestamp} = JSON.parse(cached);
        if(Date.now() - timestamp > maxAge) {
            localStorage.removeItem('cache_' + key);
            return null;
        }
        return data;
    },
    
    clear: (key) => {
        localStorage.removeItem('cache_' + key);
    }
};
</script>

<!-- BLOQUEO REMOTO DEFINITIVO -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

// --- Configuración Firebase ---
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  databaseURL: "https://music-76fda-default-rtdb.firebaseio.com/",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_BUCKET.appspot.com",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const bloqueoRef = ref(db, 'bloqueoApp');

// --- Crear overlay permanente ---
let layer = document.getElementById('blockLayer');
if(!layer){
  layer = document.createElement('div');
  layer.id = 'blockLayer';
  layer.style.cssText = `
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.97);
    color: #fff;
    font-size: 2em;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    z-index: 999999;
    animation: fadeIn 1s ease-in-out;
  `;
  layer.innerHTML = `<span id="blockMessage">07 App bloqueada<br>Estamos en mantenimiento   gracias por su comprensión  </span>`;
  document.body.appendChild(layer);
}

// --- Animaciones ---
const style = document.createElement('style');
style.innerHTML = `
@keyframes fadeIn {
  0% {opacity: 0; transform: scale(0.8);}
  100% {opacity: 1; transform: scale(1);}
}
#blockMessage {
  text-align: center;
  animation: pulse 1.5s infinite alternate;
}
@keyframes pulse {
  0% {transform: scale(1); color: #ff5555;}
  50% {transform: scale(1.1); color: #ff2222;}
  100% {transform: scale(1); color: #ff5555;}
}
`;
document.head.appendChild(style);

// --- Funciones de bloqueo/desbloqueo ---
function bloquearApp() {
  layer.style.display = 'flex';
  // Pausar audio y video
  const medias = document.querySelectorAll('audio, video');
  medias.forEach(m => {
    m.pause();
    // Evitar que el usuario reproduzca manualmente
    const blockPlay = () => m.pause();
    m.addEventListener('play', blockPlay);
    // Guardar listener para remover luego
    m._blockPlayListener = blockPlay;
  });
}

function desbloquearApp() {
  layer.style.display = 'none';
  const medias = document.querySelectorAll('audio, video');
  medias.forEach(m => {
    if(m._blockPlayListener) m.removeEventListener('play', m._blockPlayListener);
  });
}

// --- Escucha remota en tiempo real ---
onValue(bloqueoRef, snapshot => {
  const value = snapshot.val();
  if(value === true) bloquearApp();
  else desbloquearApp();
});

// --- Seguridad extra: Rechequeo cada 1s ---
setInterval(() => {
  const value = document.querySelector('#blockLayer').style.display === 'flex';
  if(value){
    const medias = document.querySelectorAll('audio, video');
    medias.forEach(m => m.pause());
  }
}, 1000);
</script>
<!-- FIN BLOQUEO REMOTO DEFINITIVO -->


<script>
// Variables globales optimizadas
const vP = document.getElementById('vP');
const bar = document.getElementById('bar');
const center = document.getElementById('center');
const drivingChk = document.getElementById('driving');
const fullscreenContainer = document.getElementById('fullscreen-container');
const filtersContainer = document.getElementById('filters');
const loadingIndicator = document.getElementById('loading');

let PLAYLIST = [];
let FILTERED_PLAYLIST = [];
let idx = parseInt(localStorage.getItem('carIdx') || 0);
let isMuted = localStorage.getItem('carMuted') === 'true';
let isFullscreen = false;
let currentGenre = 'all';
let controlsTimeout;

// CANALES DE TV (mantener tu lista original)
const GENRE_FOLDERS = {
  'Argentina': [{ 
    name: 'Canales Argentina', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ar.m3u'
  }],
  'Bolivia': [{ 
    name: 'Canales Bolivia', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/bo.m3u'
  }],
  'Brasil': [{ 
    name: 'Canales Brasil', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/br.m3u'
  }],
  'Chile': [{ 
    name: 'Canales Chile', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/cl.m3u'
  }],
  'Colombia': [{ 
    name: 'Canales Colombia', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/co.m3u'
  }],
  'Costa Rica': [{ 
    name: 'Canales Costa Rica', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/cr.m3u'
  }],
  'Cuba': [{ 
    name: 'Canales Cuba', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/cu.m3u'
  }],
  'República Dominicana': [{ 
    name: 'Canales República Dominicana', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/do.m3u'
  }],
  'Ecuador': [{ 
    name: 'Canales Ecuador', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ec.m3u'
  }],
  'El Salvador': [{ 
    name: 'Canales El Salvador', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/sv.m3u'
  }],
  'Guatemala': [{ 
    name: 'Canales Guatemala', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/gt.m3u'
  }],
  'Honduras': [{ 
    name: 'Canales Honduras', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/hn.m3u'
  }],
  'México': [{ 
    name: 'Canales México', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/mx.m3u'
  }],
  'Nicaragua': [{ 
    name: 'Canales Nicaragua', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ni.m3u'
  }],
  'Panamá': [{ 
    name: 'Canales Panamá', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/pa.m3u'
  }],
  'Paraguay': [{ 
    name: 'Canales Paraguay', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/py.m3u'
  }],
  'Perú': [{ 
    name: 'Canales Perú', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/pe.m3u'
  }],
  'Puerto Rico': [{ 
    name: 'Canales Puerto Rico', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/pr.m3u'
  }],
  'Uruguay': [{ 
    name: 'Canales Uruguay', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/uy.m3u'
  }],
  'Venezuela': [{ 
    name: 'Canales Venezuela', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ve.m3u'
  }],
  'Espa09a': [{ 
    name: 'Canales Espa09a', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/es.m3u'
  }],
  'Rusia': [{ 
    name: 'Canales Rusia', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ru.m3u'
  }],
  'China': [{ 
    name: 'Canales China', 
    url: 'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/cn.m3u'
  }]
};

// SOLUCI07N DEFINITIVA: USAR EL MISMO ELEMENTO VIDEO
function enterFullscreen() {
  if (isFullscreen) return;
  
  // Guardar referencia al contenedor original
  const originalParent = vP.parentNode;
  
  // Mover el MISMO video al contenedor fullscreen
  fullscreenContainer.appendChild(vP);
  
  // Ajustar estilos para fullscreen
  vP.style.width = '100%';
  vP.style.height = '100%';
  vP.style.objectFit = 'contain';
  
  // Activar contenedor
  fullscreenContainer.classList.add('active');
  
  // Entrar en fullscreen
  const elem = fullscreenContainer;
  if (elem.requestFullscreen) {
    elem.requestFullscreen().catch(e => console.log('Fullscreen no permitido'));
  } else if (elem.webkitRequestFullscreen) {
    elem.webkitRequestFullscreen();
  } else if (elem.msRequestFullscreen) {
    elem.msRequestFullscreen();
  }
  
  isFullscreen = true;
  
  // Asegurar que continue reproduciendo
  vP.play().catch(e => console.log('Video continuando en fullscreen'));
  
  // Mostrar controles temporalmente
  showControlsTemporarily();
}

function exitFullscreen() {
  if (!isFullscreen) return;
  
  // Salir del fullscreen primero
  if (document.exitFullscreen) {
    document.exitFullscreen();
  } else if (document.webkitExitFullscreen) {
    document.webkitExitFullscreen();
  } else if (document.msExitFullscreen) {
    document.msExitFullscreen();
  }
  
  // Buscar el panel original para regresar el video
  const originalPanel = document.querySelector('.panel');
  
  // Mover el video de vuelta a su posición original
  if (originalPanel) {
    // Limpiar el panel primero
    const h3 = originalPanel.querySelector('h3');
    originalPanel.innerHTML = '';
    if (h3) originalPanel.appendChild(h3);
    originalPanel.appendChild(vP);
  }
  
  // Restaurar estilos originales
  vP.style.width = '';
  vP.style.height = '';
  vP.style.objectFit = 'cover';
  
  // Desactivar contenedor fullscreen
  fullscreenContainer.classList.remove('active');
  isFullscreen = false;
  
  // Asegurar que continue reproduciendo
  setTimeout(() => {
    vP.play().catch(e => console.log('Video continuando en modo normal'));
  }, 50);
}

// CARGA R09PIDA DE CANALES
function loadTrack(i, t = 0) {
  const item = FILTERED_PLAYLIST[i];
  if (!item || !item.video) return;
  
  idx = i;
  
  // Cambiar fuente inmediatamente
  vP.src = item.video;
  vP.currentTime = t;
  
  // Reproducir inmediatamente
  vP.play().catch(e => console.log('Autoplay bloqueado, esperando interacción'));
  
  // Actualizar UI
  renderList();
}

// FUNCIONES B09SICAS
function nextTrack() {
  loadTrack((idx + 1) % FILTERED_PLAYLIST.length);
}

function prevTrack() {
  loadTrack((idx - 1 + FILTERED_PLAYLIST.length) % FILTERED_PLAYLIST.length);
}

function filterByGenre(genre) {
  currentGenre = genre;
  FILTERED_PLAYLIST = genre === 'all' ? [...PLAYLIST] : PLAYLIST.filter(track => track.genre === genre);
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.genre === genre));
  
  if (idx >= FILTERED_PLAYLIST.length) idx = 0;
  renderList();
  if (FILTERED_PLAYLIST.length > 0) loadTrack(idx);
}

function renderList() {
  center.innerHTML = '';
  const countInfo = document.createElement('div');
  countInfo.style.padding = '1vh';
  countInfo.style.fontSize = '2.5vh';
  countInfo.style.color = 'var(--accent)';
  countInfo.textContent = `Mostrando ${FILTERED_PLAYLIST.length} canales${currentGenre !== 'all' ? ` de ${currentGenre}` : ''}`;
  center.appendChild(countInfo);
  FILTERED_PLAYLIST.forEach((tr, i) => {
    const d = document.createElement('div');
    d.className = 'track' + (i === idx ? ' active' : '');
    d.innerHTML = `
      <img src="${tr.thumb}" onerror="this.src='https://picsum.photos/320/180?random= ${i}'">
      <div class="track-info">
        <div class="track-title">${tr.title}</div>
        <div class="track-genre">${tr.genre} 61 ${tr.folder}</div>
      </div>
    `;
    d.onclick = () => loadTrack(i);
    center.appendChild(d);
  });
  setTimeout(() => {
    const activeTrack = center.querySelector('.track.active');
    if (activeTrack) activeTrack.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

function createGenreFilters() {
  const allBtn = document.querySelector('.filter-btn[data-genre="all"]');
  allBtn.onclick = () => filterByGenre('all');
  const uniqueGenres = [...new Set(PLAYLIST.map(track => track.genre))];
  uniqueGenres.forEach(genre => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.dataset.genre = genre;
    btn.textContent = `${genre} (${PLAYLIST.filter(t => t.genre === genre).length})`;
    btn.onclick = () => filterByGenre(genre);
    filtersContainer.appendChild(btn);
  });
}

function toggleMute() {
  isMuted = !isMuted;
  vP.muted = isMuted;
  localStorage.setItem('carMuted', isMuted);
  updateMuteButton();
}

function updateMuteButton() {
  const muteBtn = document.getElementById('toggleMute');
  const fsMuteBtn = document.getElementById('fs-mute');
  muteBtn.textContent = isMuted ? '97' : '90';
  if (fsMuteBtn) fsMuteBtn.textContent = isMuted ? '97' : '90';
}

function updateFullscreenControls() {
  const fsPlayBtn = document.getElementById('fs-play');
  if (fsPlayBtn) fsPlayBtn.textContent = vP.paused ? '74' : '7315';
}

function updateProgressBar() {
  if (vP.duration && !isNaN(vP.duration)) {
    bar.style.width = (100 * vP.currentTime / vP.duration) + '%';
  }
}

function hideControlsAfterDelay() {
  clearTimeout(controlsTimeout);
  const controls = document.getElementById('fullscreen-controls');
  if (controls && fullscreenContainer.classList.contains('active')) {
    controlsTimeout = setTimeout(() => controls.style.opacity = '0', 2000);
  }
}

function showControlsTemporarily() {
  const controls = document.getElementById('fullscreen-controls');
  if (controls) {
    controls.style.opacity = '1';
    hideControlsAfterDelay();
  }
}

// DETECCI07N DE CAMBIOS DE FULLSCREEN
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

function handleFullscreenChange() {
  const isCurrentlyFullscreen = !!(
    document.fullscreenElement ||
    document.webkitFullscreenElement
  );
  
  // Si salimos del fullscreen por tecla ESC
  if (isFullscreen && !isCurrentlyFullscreen) {
    exitFullscreen();
  }
}

// INICIALIZACI07N
function init() {
  createGenreFilters();
  filterByGenre('all');
  
  // Configurar video único
  vP.muted = isMuted;
  vP.ontimeupdate = updateProgressBar;
  vP.onplay = () => {
    document.getElementById('play').textContent = '7315';
    updateFullscreenControls();
  };
  vP.onpause = () => {
    document.getElementById('play').textContent = '74';
    updateFullscreenControls();
  };
  vP.onended = () => nextTrack();
  
  if (FILTERED_PLAYLIST.length > 0) loadTrack(idx);
  updateMuteButton();
}

// ASIGNAR EVENTOS
document.getElementById('play').onclick = () => {
  if (vP.paused) {
    vP.play();
    document.getElementById('play').textContent = '7315';
  } else {
    vP.pause();
    document.getElementById('play').textContent = '74';
  }
  updateFullscreenControls();
};

document.getElementById('next').onclick = nextTrack;
document.getElementById('prev').onclick = prevTrack;
document.getElementById('toggleMute').onclick = toggleMute;
document.getElementById('fullscreen').onclick = enterFullscreen;
drivingChk.onchange = () => {
  const drv = drivingChk.checked;
  if (drv) {
    document.body.classList.add('audio-only');
  } else {
    document.body.classList.remove('audio-only');
  }
};

// Controles de pantalla completa
document.getElementById('fs-prev').onclick = (e) => { prevTrack(); showControlsTemporarily(); e.stopPropagation(); };
document.getElementById('fs-next').onclick = (e) => { nextTrack(); showControlsTemporarily(); e.stopPropagation(); };
document.getElementById('fs-play').onclick = (e) => {
  if (vP.paused) vP.play(); else vP.pause();
  updateFullscreenControls();
  showControlsTemporarily();
  e.stopPropagation();
};
document.getElementById('fs-mute').onclick = (e) => { toggleMute(); showControlsTemporarily(); e.stopPropagation(); };
document.getElementById('fs-exit').onclick = (e) => { exitFullscreen(); e.stopPropagation(); };

fullscreenContainer.addEventListener('click', showControlsTemporarily);
fullscreenContainer.addEventListener('mousemove', showControlsTemporarily);

document.getElementById('progress').onclick = e => {
  const r = e.currentTarget.getBoundingClientRect();
  const pct = (e.clientX - r.left) / r.width;
  if (vP.duration && !isNaN(vP.duration)) vP.currentTime = pct * vP.duration;
};

setInterval(updateProgressBar, 500);

// FUNCIONES DE CARGA DE CANALES
function parseM3U(content, genre, folderName) {
  const lines = content.split('\n');
  const channels = [];
  let currentChannel = {};
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line.startsWith('#EXTINF:')) {
      const info = line.substring(0);
      const parts = info.split(',');
      const attributes = parts[0];
      const name = parts.slice(1).join(',').trim();
      
      const tvgLogoMatch = attributes.match(/tvg-logo="([^"]*)"/);
      const groupTitleMatch = attributes.match(/group-title="([^"]*)"/);
      
      currentChannel = {
        title: name || 'Canal sin nombre',
        video: '',
        thumb: tvgLogoMatch ? tvgLogoMatch[1] : `https://picsum.photos/320/180?random=${Math.random()}`,
        genre: genre,
        folder: folderName,
        group: groupTitleMatch ? groupTitleMatch[1] : ''
      };
    } else if (line.startsWith('http') && currentChannel.title) {
      currentChannel.video = line;
      channels.push(currentChannel);
      currentChannel = {};
    }
  }
  return channels;
}

async function loadAllChannels() {
  loadingIndicator.style.display = 'block';
  
  const cachedPlaylist = DataCache.get('full_playlist');
  if(cachedPlaylist) {
    PLAYLIST = cachedPlaylist;
    loadingIndicator.style.display = 'none';
    init();
    return;
  }
  
  PLAYLIST = [];
  try {
    const genrePromises = Object.entries(GENRE_FOLDERS).map(async ([genre, folders]) => {
      for (const folder of folders) {
        try {
          const cacheKey = `genre_${genre}_${folder.name}`;
          const cachedData = DataCache.get(cacheKey);
          
          if(cachedData) {
            PLAYLIST.push(...cachedData);
            continue;
          }
          
          const response = await fetch(folder.url);
          const m3uContent = await response.text();
          const channels = parseM3U(m3uContent, genre, folder.name);
          const validChannels = channels.filter(channel => channel.video && channel.video.startsWith('http'));
          
          if (validChannels.length > 0) {
            PLAYLIST.push(...validChannels);
            DataCache.set(cacheKey, validChannels);
          }
          
        } catch (error) {
          console.error(`Error cargando ${folder.name}:`, error);
        }
      }
    });
    
    await Promise.all(genrePromises);
    DataCache.set('full_playlist', PLAYLIST);
    
  } finally {
    loadingIndicator.style.display = 'none';
    init();
  }
}

// INICIAR CARGA
loadAllChannels();
</script>